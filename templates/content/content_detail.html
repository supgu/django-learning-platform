{% extends 'base.html' %}
{% load static %}

{% block title %}{{ content.title }} - å†…å®¹è¯¦æƒ…{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- å†…å®¹è¯¦æƒ…å¡ç‰‡ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h1 class="card-title mb-0">{{ content.title }}</h1>
                    <div class="d-flex align-items-center">
                        {% if content.privacy == 'public' %}
                            <span class="badge bg-success me-2">
                                <i class="fas fa-globe"></i> å…¬å¼€
                            </span>
                        {% else %}
                            <span class="badge bg-warning me-2">
                                <i class="fas fa-lock"></i> ç§å¯†
                            </span>
                        {% endif %}
                        {% if user == content.author %}
                            <a href="{% url 'content:content_update' content.pk %}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- ä½œè€…ä¿¡æ¯ -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <i class="fas fa-user-circle fa-2x text-muted"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">{{ content.author.username }}</h6>
                            <small class="text-muted">{{ content.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</small>
                        </div>
                    </div>
                    
                    <!-- å†…å®¹æ­£æ–‡ -->
                    <div class="content-body mb-4">
                        {{ content.content|linebreaks }}
                    </div>
                    
                    <!-- æ ‡ç­¾ -->
                    {% if content.tags.all %}
                        <div class="mb-3">
                            <h6>æ ‡ç­¾ï¼š</h6>
                            {% for tag in content.tags.all %}
                                <span class="badge bg-dark-theme me-1">
                                    <i class="fas fa-tag"></i> {{ tag.name }}
                                </span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="row text-center mb-3">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <i class="fas fa-eye text-primary"></i>
                                <span class="ms-1">{{ content.views_count }} æµè§ˆ</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <i class="fas fa-thumbs-up text-success"></i>
                                <span class="ms-1">{{ content.likes_count }} ç‚¹èµ</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <i class="fas fa-heart text-danger"></i>
                                <span class="ms-1">{{ content.favorites_count }} æ”¶è—</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <i class="fas fa-comment text-info"></i>
                                <span class="ms-1">{{ content.comments_count }} è¯„è®º</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="d-flex justify-content-center gap-2">
                        <button class="like-btn {% if content.is_liked_by_user %}liked{% endif %}" data-content-id="{{ content.id }}">
                            <svg class="heart-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="like-count">{{ content.likes_count }}</span>
                        </button>
                        <button class="btn btn-danger" 
                                data-content-id="{{ content.id }}"
                                onclick="toggleFavorite(this.dataset.contentId, this)">
                            <i class="fas fa-heart"></i> 
                            <span id="favorite-text-{{ content.id }}">æ”¶è—</span>
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shareModal">
                            <i class="fas fa-share"></i> åˆ†äº«
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> è¯„è®º ({{ content.comments_count }})</h5>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                        <!-- è¯„è®ºè¡¨å• -->
                        <form id="comment-form" method="post" action="{% url 'content:add_comment' content.id %}" class="mb-4">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea class="form-control" name="text" rows="3" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> å‘è¡¨è¯„è®º
                                </button>
                                <button type="button" id="ai-comment-btn" class="btn btn-info">
                                    <i class="fas fa-robot"></i> AIæ™ºèƒ½ç‚¹è¯„
                                    <small class="text-muted d-block">ç”±DeepSeek AIæä¾›</small>
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            è¯· <a href="{% url 'accounts:login' %}">ç™»å½•</a> åå‘è¡¨è¯„è®º
                        </div>
                    {% endif %}
                    
                    <!-- è¯„è®ºåˆ—è¡¨ -->
                    <div class="comments-list">
                        {% if content.comments.all %}
                            {% for comment in content.comments.all %}
                                <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="{{ comment.id }}">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar-sm me-3">
                                            {% if comment.author.userprofile.avatar %}
                                                <img src="{{ comment.author.userprofile.avatar.url }}" alt="{{ comment.author.username }}" class="rounded-circle" width="40" height="40">
                                            {% else %}
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    {{ comment.author.username|first|upper }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                <strong class="me-2">{{ comment.author.username }}</strong>
                                                {% if comment.author.username == 'AIåŠ©æ‰‹' %}
                                                    <span class="badge bg-info text-white me-2">
                                                        <i class="fas fa-robot"></i> AIè¯„è®º
                                                    </span>
                                                    <small class="text-muted">ç”±DeepSeek AIç”Ÿæˆ</small>
                                                {% else %}
                                                    <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                                                {% endif %}
                                            </div>
                                            <p class="mb-0">{{ comment.text }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-comment-slash fa-2x"></i>
                                <p class="mt-2">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ  -->
        <div class="col-lg-4">
            <!-- ä½œè€…ä¿¡æ¯å¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-user"></i> ä½œè€…ä¿¡æ¯</h6>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-user-circle fa-4x text-muted mb-3"></i>
                    <h6>{{ content.author.username }}</h6>
                    <p class="text-muted small">æ³¨å†Œæ—¶é—´ï¼š{{ content.author.date_joined|date:"Yå¹´mæœˆdæ—¥" }}</p>
                    <a href="{% url 'content:user_profile' content.author.username %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> æŸ¥çœ‹ä¸»é¡µ
                    </a>
                </div>
            </div>
            
            <!-- ç›¸å…³å†…å®¹ -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-list"></i> ç›¸å…³å†…å®¹</h6>
                </div>
                <div class="card-body">
                    <div class="text-muted text-center py-3">
                        <span class="search-icon-medium">ğŸ”</span>
                        <p class="mt-2 small">æš‚æ— ç›¸å…³å†…å®¹</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†äº«æ¨¡æ€æ¡† -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-share"></i> åˆ†äº«å†…å®¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">åˆ†äº«é“¾æ¥ï¼š</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ request.build_absolute_uri }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this)">
                            <i class="fas fa-copy"></i> å¤åˆ¶
                        </button>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-2">
                    <a href="#" class="btn btn-outline-primary">
                        <i class="fab fa-weibo"></i> å¾®åš
                    </a>
                    <a href="#" class="btn btn-outline-success">
                        <i class="fab fa-weixin"></i> å¾®ä¿¡
                    </a>
                    <a href="#" class="btn btn-outline-info">
                        <i class="fab fa-qq"></i> QQ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// æ”¶è—åŠŸèƒ½
function toggleFavorite(contentId, button) {
    fetch(`/content/${contentId}/toggle-favorite/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°UI
            var icon = button.querySelector('i');
            var text = button.querySelector('span');
            
            if (data.favorited) {
                button.classList.add('favorited', 'btn-danger');
                button.classList.remove('btn-outline-danger');
                icon.classList.remove('far');
                icon.classList.add('fas');
                text.textContent = 'å·²æ”¶è—';
            } else {
                button.classList.remove('favorited', 'btn-danger');
                button.classList.add('btn-outline-danger');
                icon.classList.remove('fas');
                icon.classList.add('far');
                text.textContent = 'æ”¶è—';
            }
            
            // æ›´æ–°æ”¶è—æ•°é‡
            const favoriteCount = document.querySelector('.favorite-count');
            if (favoriteCount) {
                favoriteCount.textContent = data.favorites_count;
            }
        } else {
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    });
}

// æ”¶è—åŠŸèƒ½äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    // è¯„è®ºè¡¨å•æäº¤
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘è¡¨ä¸­...';
            submitBtn.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ·»åŠ æ–°è¯„è®ºåˆ°åˆ—è¡¨
                    addCommentToList(data.comment);
                    // æ¸…ç©ºè¡¨å•
                    this.querySelector('textarea').value = '';
                    showNotification('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
                } else {
                    showNotification(data.error || 'è¯„è®ºå‘è¡¨å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // AIè¯„è®ºåŠŸèƒ½
    const aiCommentBtn = document.getElementById('ai-comment-btn');
    if (aiCommentBtn) {
        aiCommentBtn.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIæ€è€ƒä¸­...';
            this.disabled = true;
            
            fetch(`{% url 'content:ai_comment' content.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                 if (data.success) {
                     // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„è¯„è®ºæ•°æ®
                     const aiComment = data.comment_data || {
                         id: 'ai-' + Date.now(),
                         text: data.comment,
                         author: 'AIåŠ©æ‰‹',
                         created_at: new Date().toLocaleString('zh-CN'),
                         is_ai: true
                     };
                     addCommentToList(aiComment);
                     showNotification('AIè¯„è®ºç”ŸæˆæˆåŠŸï¼ç”±DeepSeek AIæä¾›æ™ºèƒ½åˆ†æ', 'success');
                     
                     // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºå®Œæ•´çš„è¯„è®ºåˆ—è¡¨
                     setTimeout(() => {
                         location.reload();
                     }, 1500);
                 } else {
                     showNotification(data.error || 'AIè¯„è®ºç”Ÿæˆå¤±è´¥', 'error');
                 }
             })
            .catch(error => {
                console.error('Error:', error);
                showNotification('AIè¯„è®ºç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            })
            .finally(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    }
});

// æ·»åŠ è¯„è®ºåˆ°åˆ—è¡¨
function addCommentToList(comment) {
    const commentsList = document.querySelector('.comments-list');
    const noCommentsMsg = commentsList.querySelector('.text-muted.text-center');
    
    // å¦‚æœå­˜åœ¨"æš‚æ— è¯„è®º"æ¶ˆæ¯ï¼Œç§»é™¤å®ƒ
    if (noCommentsMsg) {
        noCommentsMsg.remove();
    }
    
    const commentHtml = `
        <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="${comment.id}">
            <div class="d-flex align-items-start">
                <div class="avatar-sm me-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        ${comment.author.charAt(0).toUpperCase()}
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">${comment.author}</strong>
                        ${comment.is_ai ? `
                            <span class="badge bg-info text-white me-2">
                                <i class="fas fa-robot"></i> AIè¯„è®º
                            </span>
                            <small class="text-muted">ç”±DeepSeek AIç”Ÿæˆ</small>
                        ` : `
                            <small class="text-muted">${comment.created_at}</small>
                        `}
                    </div>
                    <p class="mb-0">${comment.text}</p>
                </div>
            </div>
        </div>
    `;
    
    commentsList.insertAdjacentHTML('afterbegin', commentHtml);
}

function fallbackCopyTextToClipboard(text) {
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        var successful = document.execCommand('copy');
        if (successful) {
            showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } else {
            showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
    } catch (err) {
        showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
    }
    
    document.body.removeChild(textArea);
}

// å¤åˆ¶é“¾æ¥
function copyToClipboard(button) {
    var input = button.parentElement.querySelector('input');
    input.select();
    document.execCommand('copy');
    
    var originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(function() {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>
{% endblock %}